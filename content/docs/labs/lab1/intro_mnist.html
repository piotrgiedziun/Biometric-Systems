<head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script type="text/javascript">
    var canvas, ctx;

    var mouseX,
      mouseY,
      mouseDown = 0;

    var touchX, touchY;

    var lastX,
      lastY = -1;

    function drawLine(ctx, x, y, size) {
      if (lastX == -1) {
        lastX = x;
        lastY = y;
      }

      r = 255;
      g = 255;
      b = 255;
      a = 255;

      ctx.strokeStyle = "rgba(" + r + "," + g + "," + b + "," + a / 255 + ")";
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.lineWidth = size;
      ctx.stroke();
      ctx.closePath();

      lastX = x;
      lastY = y;
    }

    function clearCanvas(canvas, ctx) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById("rightside").innerHTML = "";
    }

    function sketchpad_mouseDown() {
      mouseDown = 1;
      drawLine(ctx, mouseX, mouseY, 12);
    }

    function sketchpad_mouseUp() {
      mouseDown = 0;

      lastX = -1;
      lastY = -1;
    }

    function sketchpad_mouseMove(e) {
      getMousePos(e);

      if (mouseDown == 1) {
        drawLine(ctx, mouseX, mouseY, 12);
      }
    }

    function getMousePos(e) {
      if (!e) var e = event;

      if (e.offsetX) {
        mouseX = e.offsetX;
        mouseY = e.offsetY;
      } else if (e.layerX) {
        mouseX = e.layerX;
        mouseY = e.layerY;
      }
    }

    function sketchpad_touchStart() {
      getTouchPos();

      drawLine(ctx, touchX, touchY, 12);

      event.preventDefault();
    }

    function sketchpad_touchEnd() {
      lastX = -1;
      lastY = -1;
    }

    function sketchpad_touchMove(e) {
      getTouchPos(e);

      drawLine(ctx, touchX, touchY, 12);

      event.preventDefault();
    }

    function getTouchPos(e) {
      if (!e) var e = event;

      if (e.touches) {
        if (e.touches.length == 1) {
          var touch = e.touches[0];
          touchX = touch.pageX - touch.target.offsetLeft;
          touchY = touch.pageY - touch.target.offsetTop;
        }
      }
    }

    async function init() {
      canvas = document.getElementById("sketchpad");

      if (canvas.getContext) ctx = canvas.getContext("2d");

      if (ctx) {
        canvas.addEventListener("mousedown", sketchpad_mouseDown, false);
        canvas.addEventListener("mousemove", sketchpad_mouseMove, false);
        window.addEventListener("mouseup", sketchpad_mouseUp, false);

        canvas.addEventListener("touchstart", sketchpad_touchStart, false);
        canvas.addEventListener("touchend", sketchpad_touchEnd, false);
        canvas.addEventListener("touchmove", sketchpad_touchMove, false);
      }
      var loadDiv = document.getElementById("load");
      var demoDiv = document.getElementById("demo");
      loadDiv.style.display = "none";
      model = await tf.loadLayersModel("../lab1/model.json");
      demoDiv.style.display = "block";
    }

    function predict() {
      const imageData = ctx.getImageData(0, 0, 140, 140);

      var tfImg = tf.browser.fromPixels(imageData, 1);
      var smalImg = tf.image.resizeBilinear(tfImg, [28, 28]);
      smalImg = tf.cast(smalImg, "float32");
      const tensor = smalImg
        .expandDims(1)
        .reshape([1, 28, 28, 1])
        .div(tf.scalar(255));
      console.log("xdf", tensor.shape);

      const prediction = model.predict(tensor);
      const predictedValues = prediction.dataSync();
      var isThereAnyPrediction = false;
      for (index = 0; index < predictedValues.length; index++) {
        if (predictedValues[index] > 0.5) {
          isThereAnyPrediction = true;
          document.getElementById("rightside").innerHTML = index;
        }
      }
      if (!isThereAnyPrediction) {
        document.getElementById("rightside").innerHTML = "-";
      }
    }
  </script>

  <style>
    .rightside {
      width: 140px;
      height: 125px;
      background-color: #def;
      border-radius: 4px;
      font-size: 70px;
      text-align: center;
    }

    .leftside {
      width: 150px;
      height: 200px;
    }

    #sketchpad {
      float: left;
      height: 140px;
      width: 140px;
      border: 2px solid #888;
      border-radius: 4px;
      position: relative;
      background-color: black;
      /* Necessary for correct mouse co-ords in Firefox */
    }
    #demo {
      display: none;
    }
  </style>
</head>

<div id="load">
  <input type="submit" value="Load demo" onclick="init();" />
</div>
<div id="demo">
  <div class="leftside">
    <canvas id="sketchpad" height="140" width="140"></canvas>
    <input type="submit" value="Predict" onclick="predict();" />
    <input type="submit" value="Clear" onclick="clearCanvas(canvas,ctx);" />
  </div>
  <div id="rightside" class="rightside"></div>
</div>
